name: Deploy to Azure Container Apps

on:
  push:
    branches: [ main ]
    paths:
      - 'cloud-api/**'
      - 'src/**'
      - 'Dockerfile*'
      - '.github/workflows/azure-deploy.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
          - development

env:
  RESOURCE_GROUP: quotrading-rg
  ACR_NAME: quotradingacr
  SIGNAL_ENGINE_APP: signal-engine
  TRADING_BOT_APP: trading-bot

jobs:
  build-and-push:
    name: Build and Push Docker Images
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Login to Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: Login to Azure Container Registry
      run: az acr login --name ${{ env.ACR_NAME }}
    
    - name: Build and push signal engine image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./cloud-api/Dockerfile
        push: true
        tags: |
          ${{ env.ACR_NAME }}.azurecr.io/signal-engine:latest
          ${{ env.ACR_NAME }}.azurecr.io/signal-engine:${{ github.sha }}
        cache-from: type=registry,ref=${{ env.ACR_NAME }}.azurecr.io/signal-engine:latest
        cache-to: type=inline
    
    - name: Build and push trading bot image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile.bot
        push: true
        tags: |
          ${{ env.ACR_NAME }}.azurecr.io/trading-bot:latest
          ${{ env.ACR_NAME }}.azurecr.io/trading-bot:${{ github.sha }}
        cache-from: type=registry,ref=${{ env.ACR_NAME }}.azurecr.io/trading-bot:latest
        cache-to: type=inline
    
    - name: Logout from Azure
      run: az logout

  deploy-signal-engine:
    name: Deploy Signal Engine
    runs-on: ubuntu-latest
    needs: build-and-push
    environment: ${{ github.event.inputs.environment || 'production' }}
    
    steps:
    - name: Login to Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: Deploy to Container Apps
      run: |
        az containerapp update \
          --name ${{ env.SIGNAL_ENGINE_APP }} \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --image ${{ env.ACR_NAME }}.azurecr.io/signal-engine:${{ github.sha }}
    
    - name: Get deployment URL
      id: get-url
      run: |
        URL=$(az containerapp show \
          --name ${{ env.SIGNAL_ENGINE_APP }} \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --query properties.configuration.ingress.fqdn -o tsv)
        echo "url=https://$URL" >> $GITHUB_OUTPUT
    
    - name: Health check
      run: |
        sleep 30
        curl -f ${{ steps.get-url.outputs.url }}/health || exit 1
    
    - name: Logout from Azure
      run: az logout
    
    outputs:
      url: ${{ steps.get-url.outputs.url }}

  deploy-trading-bot:
    name: Deploy Trading Bot
    runs-on: ubuntu-latest
    needs: [build-and-push, deploy-signal-engine]
    environment: ${{ github.event.inputs.environment || 'production' }}
    if: github.event.inputs.environment == 'production' || github.ref == 'refs/heads/main'
    
    steps:
    - name: Login to Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: Deploy to Container Apps
      run: |
        az containerapp update \
          --name ${{ env.TRADING_BOT_APP }} \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --image ${{ env.ACR_NAME }}.azurecr.io/trading-bot:${{ github.sha }}
    
    - name: Logout from Azure
      run: az logout

  notify:
    name: Notification
    runs-on: ubuntu-latest
    needs: [deploy-signal-engine, deploy-trading-bot]
    if: always()
    
    steps:
    - name: Send deployment notification
      run: |
        echo "Deployment Status:"
        echo "Signal Engine: ${{ needs.deploy-signal-engine.result }}"
        echo "Trading Bot: ${{ needs.deploy-trading-bot.result }}"
        echo "URL: ${{ needs.deploy-signal-engine.outputs.url }}"
