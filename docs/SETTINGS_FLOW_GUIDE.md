# GUI Settings Flow Documentation

This document explains how settings flow from the GUI to the bot, ensuring all dynamic and fixed features work correctly.

## Settings Flow Overview

```
User Input (GUI) 
    ↓
Config.json (saved locally)
    ↓
.env file (generated by GUI)
    ↓
Bot Configuration (loaded at startup)
    ↓
Session State (tracks runtime state)
```

## 1. GUI Settings (customer/QuoTrading_Launcher.py)

The GUI collects the following settings from the user:

### Account Settings
- **Broker Type**: Prop Firm or Live Broker
- **Broker**: TopStep, Tradovate, etc.
- **Account Size**: Starting equity (numeric, e.g., 50000) - **Used by recovery mode to track initial balance**
- **Selected Account**: Fetched account from broker API

### Risk Management
- **Max Contracts**: Maximum contracts per trade (enforced limits: Prop Firm = 5, Live = 25)
- **Max Trades/Day**: Daily trade limit
- **Daily Loss Limit**: Dollar amount for daily loss ($) - **Primary limit tracked by recovery mode**

### Trading Settings
- **Symbols**: Multiple symbol selection (ES, NQ, RTY, YM, CL, GC)
- **Confidence Threshold**: Minimum AI confidence (%) for taking signals
- **Dynamic Confidence**: Auto-increase confidence when approaching daily loss limit
- **Dynamic Contracts**: Use AI confidence to scale contracts dynamically
- **Shadow Mode**: Paper trading mode (no real trades)

### Recovery Mode
- **Recovery Mode**: Enable/disable recovery mode behavior when approaching daily loss limit
  - **Enabled (ON)**: 
    - ✅ Bot **CONTINUES TRADING** when approaching daily loss limit
    - Auto-increases confidence threshold (75-90% based on severity)
    - Dynamically reduces position size
    - Shows warning: "RECOVERY MODE ACTIVE - Bot continues trading"
  - **Disabled (OFF - Default)**:
    - ⛔ Bot **STOPS TRADING** at 80% of daily loss limit
    - Bot stays running and monitoring
    - Resumes trading after daily reset (6 PM ET)
    - Shows warning: "Bot will STOP trading. Consider enabling Recovery Mode"
  - **Tracks**: Initial balance (from account_size) and daily loss limit only

## 2. Configuration Persistence (config.json)

The GUI saves user settings to `config.json` in the root directory. This file:
- Stores broker credentials (encrypted recommended for production)
- Saves user preferences across sessions
- Used by GUI to pre-populate fields on next launch

**Note**: `config.json` is in `.gitignore` and should never be committed.

## 3. Environment File Generation (.env)

When the user clicks "Start Bot", the GUI generates a `.env` file with all settings:

```bash
# QuoTrading Account
ACCOUNT_SIZE=50000                    # Numeric value (not "50k")

# Broker Configuration
BROKER=TopStep
BROKER_API_TOKEN=xxx
BROKER_USERNAME=user@example.com

# Trading Configuration
BOT_INSTRUMENTS=ES,NQ
BOT_MAX_CONTRACTS=3
BOT_MAX_TRADES_PER_DAY=10
BOT_MAX_DRAWDOWN_PERCENT=8.0
BOT_TRAILING_DRAWDOWN=true
BOT_DAILY_LOSS_LIMIT=1000

# AI/Confidence Settings
BOT_CONFIDENCE_THRESHOLD=65.0
BOT_DYNAMIC_CONFIDENCE=true
BOT_DYNAMIC_CONTRACTS=true

# Recovery Mode
BOT_RECOVERY_MODE=false
```

## 4. Bot Configuration Loading (src/config.py)

The bot loads settings in this priority order:

1. **Default Values**: From `BotConfiguration` dataclass
2. **JSON Config**: From `config.json` (if exists)
3. **Environment Variables**: From `.env` file (highest priority)

### Key Loading Functions

#### `load_from_env()`
Loads ALL environment variables and converts them to proper types:
- Strings → appropriate type (float, int, bool)
- Percentages → decimals (65.0% → 0.65 for internal use)
- Account size → float (handles both "50000" and "50k" format)

#### `load_config()`
Main loading function that:
1. Loads base config for environment (development/staging/production)
2. Merges JSON config
3. **Overrides with environment variables** (only if env var is actually set)
4. Validates configuration

## 5. Session State Management (src/session_state.py)

The `SessionStateManager` tracks:

### Daily State
- **Trading Date**: Current trading day
- **Starting Equity**: Initial balance at start of day
- **Current Equity**: Real-time balance
- **Peak Equity**: Highest balance reached
- **Daily P&L**: Profit/loss for the day
- **Total Trades Today**: Number of trades executed

### Recovery Mode Tracking
- **Initial Balance**: Saved at bot startup
- **Daily Loss %**: Calculated from starting equity
- **Current Drawdown %**: Distance from starting balance
- **Approaching Failure**: True if at 80%+ of limits

### Warnings & Recommendations
The session state generates smart warnings based on:
- Account type (prop firm vs live broker)
- Current performance vs limits
- Recovery mode status

Example recommendations:
- "Increase confidence to 75%" (when at 85% of limits)
- "Reduce contracts to 2" (when approaching failure)
- "Enable recovery mode" (when at 80%+ of limits)

## 6. Settings Validation

All settings are validated at multiple levels:

### GUI Validation
- Account size > 0
- Daily loss limit > 0
- At least one symbol selected
- Contracts within broker limits

### Config Validation
- Risk per trade: 0 < value ≤ 1
- Max contracts: 1-25 (hard cap)
- Timezone: Valid pytz timezone
- Broker credentials: Present (unless backtest mode)

### Runtime Validation
- Session state checks limits every update
- Warnings generated at 80% of limits
- Recovery mode dynamically adjusts confidence

## 7. Dynamic vs Fixed Settings

### Fixed Settings (Set by User)
- Max contracts
- Max trades per day
- Confidence threshold (minimum)
- Daily loss limit (if not auto-calculated)
- Account size (initial balance for recovery mode)

### Dynamic Settings (Auto-Adjusted)
- **Dynamic Confidence**: Bot increases confidence when:
  - Performance is poor
  - Approaching daily loss limit
  - Recovery mode is active
  - Confidence scales: 75% @ 80% of daily loss limit, 85% @ 90%, 90% @ 95%+

- **Dynamic Contracts**: Bot scales contracts based on:
  - Signal confidence (higher confidence = more contracts)
  - Current performance (poor performance = fewer contracts)
  - Distance to daily loss limit (closer to limit = fewer contracts)

## 8. Recovery Mode Behavior

### When DISABLED (Default - Safest) ⛔
- Bot **STOPS TRADING** at 80% of daily loss limit
- Warning: "Bot will STOP trading. Consider enabling Recovery Mode"
- Bot continues running and monitoring (doesn't shut down)
- Trading resumes after daily reset at 6 PM ET (maintenance hour)
- User maintains full control - can manually enable recovery mode anytime
- **Best for**: Conservative traders, prop firm accounts, beginners

### When ENABLED (Aggressive Recovery) ✅
- Bot **CONTINUES TRADING** when approaching daily loss limit
- Warning: "RECOVERY MODE ACTIVE - Bot continues trading with increased confidence"
- Auto-increases confidence (75-90% based on severity of daily loss)
- Auto-reduces position size dynamically
- Only takes highest-confidence signals to attempt recovery
- Example progression:
  - 80% of daily loss limit → 75% confidence, 75% position size
  - 90% of daily loss limit → 85% confidence, 50% position size
  - 95%+ of daily loss limit → 90% confidence, 33% position size
- **Best for**: Experienced traders, live broker accounts, managed risk tolerance

**Note**: Recovery mode only tracks daily loss limit and initial balance. No maximum drawdown or trailing drawdown tracking.

## 9. Testing

Run the test suite to verify all settings load correctly:

```bash
python test_settings_loading.py
```

This tests:
1. .env file exists and is readable
2. All required environment variables are present
3. Bot configuration loads all settings correctly
4. Session state manager initializes properly
5. Warnings and recommendations system works

## 10. Troubleshooting

### Settings Not Loading
1. Check `.env` file exists
2. Verify environment variables are set correctly
3. Check for typos in variable names
4. Ensure numeric values are not in quotes

### Wrong Values Loading
1. Delete `config.json` to reset GUI preferences
2. Regenerate `.env` by clicking "Start Bot" in GUI
3. Verify environment variable priority (env vars override JSON)

### Recovery Mode Not Working
1. Check `BOT_RECOVERY_MODE=true` in `.env`
2. Verify `config.recovery_mode = True` in loaded config
3. Check session state shows `in_recovery_mode: True`

## 11. Best Practices

1. **Always use the GUI** to change settings (don't manually edit .env)
2. **Test settings** with shadow mode before live trading
3. **Monitor session state** to understand bot behavior
4. **Enable recovery mode** only if you understand the risks
5. **Use dynamic confidence** for adaptive risk management
6. **Fetch account info** before starting bot (validates balance)
7. **Auto-adjust parameters** to optimize for your account size

## 12. Security Notes

- Never commit `config.json` or `.env` to version control
- Store credentials securely on your local system
- Use environment-specific configs for different brokers
- Consider encrypting sensitive data in production

---

**For support**: support@quotrading.com
